# ConPort Database Update Guide

This guide provides information on how Context Portal (ConPort) manages its database schema changes and what you, as a user, need to know when updating your `context-portal-mcp` installation.

## 1. Automatic Database Migrations with Alembic

Starting with version `0.1.9`, ConPort utilizes **Alembic** for automated database schema management. This means:

*   **Seamless Upgrades:** When you update your `context-portal-mcp` package to a newer version that includes database schema changes, Alembic will automatically detect and apply these changes to your `context_portal/context.db` file when the ConPort server starts up.
*   **Data Preservation:** Alembic migrations are designed to preserve your existing data during schema upgrades. You should generally not need to manually export and import your data for routine updates.
*   **No Manual Intervention (Typically):** For most updates, simply updating the `context-portal-mcp` package and restarting the ConPort server is all that's required.

## 2. When Automatic Migration Might Need Attention

While designed to be seamless, there are rare scenarios where you might encounter issues or need to take manual steps:

*   **Very Old `context.db`:** If your `context.db` file is from a very old version of ConPort (e.g., pre-Alembic integration) and has a schema significantly different from the initial Alembic baseline, the automatic migration might fail.
*   **Corrupted Database:** If your `context.db` file becomes corrupted for any reason.
*   **Specific Errors:** If the ConPort server logs indicate a database schema error or an Alembic migration failure during startup.

In such cases, you might need to perform a **manual data migration**.

## 3. Manual Data Migration (Export, Delete, Import)

If automatic migration fails or you need to reset your database while preserving data, you can use ConPort's built-in export and import tools. This process effectively "rebuilds" your `context.db` with the latest schema and then re-populates it with your existing data.

**Steps for Manual Data Migration:**

1.  **Stop the ConPort Server:**
    Before proceeding, ensure the ConPort server process is completely stopped. If it's running in a terminal, press `Ctrl+C`. If it's running as a background process (e.g., in STDIO mode without a visible terminal), you might need to identify and terminate its process.
    *   **On Windows (Command Prompt/PowerShell):**
        *   Find Python processes: `wmic process where "name='python.exe'" get CommandLine,ProcessId`
        *   Look for lines containing `context_portal_mcp.main`. Note down their PIDs.
        *   Terminate processes: `taskkill /PID <PID1> /PID <PID2> /F` (replace `<PIDx>` with actual PIDs).
    *   **On Linux/macOS (Bash/Zsh):**
        *   Find process: `ps aux | grep context_portal_mcp.main`
        *   Note down the PID (usually the second column).
        *   Terminate: `kill <PID>` (or `kill -9 <PID>` for a forceful kill if `kill` doesn't work).

2.  **Export Existing Data:**
    Use the `export_conport_to_markdown` tool to save all your current ConPort data to markdown files. This will create a directory (default: `conport_export/`) containing markdown representations of your Product Context, Active Context, Decisions, Progress, System Patterns, and Custom Data.

    ```xml
    <use_mcp_tool>
    <server_name>conport</server_name>
    <tool_name>export_conport_to_markdown</tool_name>
    <arguments>
    {
      "workspace_id": "YOUR_WORKSPACE_ABSOLUTE_PATH",
      "output_path": "conport_backup"
    }
    </arguments>
    </use_mcp_tool>
    ```
    (Replace `YOUR_WORKSPACE_ABSOLUTE_PATH` with the actual path to your project workspace.)

3.  **Delete the Old `context.db` File:**
    Once your data is safely exported, delete the `context.db` file. This file is located in the `context_portal/` subdirectory within your project workspace.

    *   **On Windows (Command Prompt/PowerShell):**
        ```cmd
        del YOUR_WORKSPACE_PATH\context_portal\context.db
        ```
    *   **On Linux/macOS (Bash/Zsh):**
        ```bash
        rm YOUR_WORKSPACE_PATH/context_portal/context.db
        ```
    (Replace `YOUR_WORKSPACE_PATH` with the actual path to your project workspace.)

4.  **Restart the ConPort Server:**
    Start the ConPort server again. Since `context.db` no longer exists, Alembic will automatically create a new database with the latest schema defined by the installed `context-portal-mcp` version.

5.  **Import Data Back:**
    Use the `import_markdown_to_conport` tool to re-ingest your saved data into the newly created database.

    ```xml
    <use_mcp_tool>
    <server_name>conport</server_name>
    <tool_name>import_markdown_to_conport</tool_name>
    <arguments>
    {
      "workspace_id": "YOUR_WORKSPACE_ABSOLUTE_PATH",
      "input_path": "conport_backup"
    }
    </arguments>
    </use_mcp_tool>
    ```
    (Ensure `input_path` matches the `output_path` you used during export.)

## 4. Troubleshooting

*   **"Database is locked" / "Process cannot access the file":** This means the ConPort server is still running and holding a lock on `context.db`. Refer to Step 1 of "Manual Data Migration" to ensure all server processes are terminated.
*   **"Input directory not found":** Double-check the `output_path` you used during export and ensure the `input_path` in the import command exactly matches it.
*   **Alembic errors in server logs:** If you see specific Alembic errors during server startup, it might indicate an issue with the migration scripts or a very unusual database state. In such cases, the manual migration steps (export, delete, import) are usually the most reliable way to resolve the issue. If problems persist, consider reporting an issue on the ConPort GitHub repository.

By following this guide, you can ensure your ConPort database remains compatible and your data is safe across updates.