# Context Portal MCP Update Guide: v0.1.x to v0.2.0

This guide provides comprehensive instructions for updating your `context-portal-mcp` installation from version `0.1.9` or earlier to `v0.2.0`. This update includes significant changes, notably the integration of **Alembic** for database migrations and a new `timestamp` field for `CustomData` entries.

To ensure a smooth transition and data integrity, please follow these steps carefully.

## 1. Pre-Upgrade Cleanup

Before proceeding with any database operations or package updates, it's crucial to clear any old compiled Python files (`.pyc`) and `__pycache__` directories. This prevents potential conflicts with the new code.

*   **Locate and Delete `__pycache__` and `.pyc` files:**
    *   **On Windows (Command Prompt/PowerShell):**
        ```cmd
        for /d /r . %d in (__pycache__) do @rd /s /q "%d"
        del /s /q *.pyc
        ```
    *   **On Linux/macOS (Bash/Zsh):**
        ```bash
        find . -name "__pycache__" -type d -exec rm -rf {} +
        find . -name "*.pyc" -delete
        ```
    (Run these commands from your `context-portal` workspace root directory.)

## 2. Understanding Database Migrations

Starting with `v0.1.9`, ConPort utilizes **Alembic** for automated database schema management. This means:

*   **Seamless Upgrades (for v0.1.9 users):** If you are updating from `v0.1.9`, Alembic will generally handle database schema changes automatically when the ConPort server starts.
*   **Data Preservation:** Alembic migrations are designed to preserve your existing data during schema upgrades.
*   **No Manual Intervention (Typically for v0.1.9 users):** For most updates from `v0.1.9`, simply updating the `context-portal-mcp` package and restarting the ConPort server is all that's required.

However, for users on `v0.1.8` or earlier, or in specific scenarios, a manual migration is necessary.

## 3. Determining Your Upgrade Path

*   **Upgrading from `v0.1.9`:** You *might* be able to rely on automatic migration. Proceed to Section 4. If you encounter any issues, fall back to Section 5 (Manual Data Migration).
*   **Upgrading from `v0.1.8` or Earlier (e.g., `v0.1.6`, `v0.1.7`):** You **must** perform a manual data migration. This is due to significant schema changes (like the addition of the `timestamp` field to `CustomData` and the initial Alembic setup) that cannot be automatically handled by Alembic from these older versions. Proceed directly to Section 5.

## 4. Automatic Migration (for v0.1.9 users - Optional)

If you are currently on `v0.1.9`, you can attempt an automatic upgrade:

1.  **Stop the ConPort Server:** Ensure the ConPort server process is completely stopped. Refer to Step 1 of "Manual Data Migration" (Section 5) for detailed instructions on how to terminate processes.
2.  **Uninstall the Old Package (Recommended for Cleanliness):**
    Even if relying on automatic migration, uninstalling the old package ensures a cleaner environment.
    ```bash
    uv uninstall context-portal-mcp
    # Alternatively, using pip:
    # pip uninstall context-portal-mcp
    ```
    (Confirm with `y` if prompted by `uv` or `pip`.)

3.  **Install the New `context-portal-mcp` Package:**
    ```bash
    uv install context-portal-mcp
    # Alternatively, using pip:
    # pip install context-portal-mcp
    ```

4.  **Restart the ConPort Server:** Start the ConPort server. Alembic should automatically apply any necessary schema updates.
4.  **Verify:** Check your ConPort logs (`logs/conport.log`) for any database-related errors. If you encounter issues, proceed to Section 5.

## 5. Manual Data Migration (Recommended for v0.1.8 and Earlier, or if Automatic Fails)

This process ensures data integrity by exporting your existing data, rebuilding the database with the latest schema, and then re-importing your data.


**Steps for Manual Data Migration:**

1.  **Stop the ConPort Server:**
    Before proceeding, ensure the ConPort server process is completely stopped. If it's running in a terminal, press `Ctrl+C`. If it's running as a background process (e.g., in STDIO mode without a visible terminal), you might need to identify and terminate its process.
    *   **On Windows (Command Prompt/PowerShell):**
        *   Find Python processes: `wmic process where "name='python.exe'" get CommandLine,ProcessId`
        *   Look for lines containing `context_portal_mcp.main`. Note down their PIDs.
        *   Terminate processes: `taskkill /PID <PID1> /PID <PID2> /F` (replace `<PIDx>` with actual PIDs).
    *   **On Linux/macOS (Bash/Zsh):**
        *   Find process: `ps aux | grep context_portal_mcp.main`
        *   Note down the PID (usually the second column).
        *   Terminate: `kill <PID>` (or `kill -9 <PID>` for a forceful kill if `kill` doesn't work).

2.  **Export Existing Data:**
    Use the `export_conport_to_markdown` tool to save all your current ConPort data to markdown files. This will create a directory (default: `conport_export/`) containing markdown representations of your Product Context, Active Context, Decisions, Progress, System Patterns, and Custom Data.

    ```xml
    <use_mcp_tool>
    <server_name>conport</server_name>
    <tool_name>export_conport_to_markdown</tool_name>
    <arguments>
    {
      "workspace_id": "YOUR_WORKSPACE_ABSOLUTE_PATH",
      "output_path": "conport_backup"
    }
    </arguments>
    </use_mcp_tool>
    ```
    (Replace `YOUR_WORKSPACE_ABSOLUTE_PATH` with the actual path to your project workspace.)

3.  **Uninstall the Old `context-portal-mcp` Package:**
    This step removes the old package files from your Python environment, preventing conflicts.
    ```bash
    uv uninstall context-portal-mcp
    # Alternatively, using pip:
    # pip uninstall context-portal-mcp
    ```
    (Confirm with `y` if prompted by `uv` or `pip`.)

4.  **Clean Up Lingering Package Files (Optional but Recommended):**
    Sometimes `pip uninstall` might leave behind empty directories or `.dist-info` files. Manually remove them for a pristine state. You'll need to find your Python `site-packages` directory. Common locations include:
    *   **Windows:** `C:\PythonXX\Lib\site-packages` or `C:\Users\YourUser\AppData\Local\Programs\Python\PythonXX\Lib\site-packages`
    *   **Linux/macOS:** `/usr/local/lib/pythonX.Y/dist-packages` or `~/.local/lib/pythonX.Y/site-packages` (for user installs)

    Once you've located your `site-packages` directory, navigate into it and look for directories starting with `context_portal_mcp` or `context_portal_mcp-0.x.x.dist-info`.

    *   **On Windows (Command Prompt/PowerShell - from `site-packages`):**
        ```cmd
        rmdir /s /q context_portal_mcp
        for /d %d in (context_portal_mcp-0.*.dist-info) do @rmdir /s /q "%d"
        ```
    *   **On Linux/macOS (Bash/Zsh - from `site-packages`):**
        ```bash
        rm -rf context_portal_mcp
        rm -rf context_portal_mcp-0.*.dist-info
        ```

5.  **Delete the Old `context.db` File:**
    Once your data is safely exported and the old package is uninstalled, delete the `context.db` file. This file is located in the `context_portal/` subdirectory within your project workspace.

    *   **On Windows (Command Prompt/PowerShell):**
        ```cmd
        del YOUR_WORKSPACE_PATH\context_portal\context.db
        ```
    *   **On Linux/macOS (Bash/Zsh):**
        ```bash
        rm YOUR_WORKSPACE_PATH/context_portal/context.db
        ```
    (Replace `YOUR_WORKSPACE_PATH` with the actual path to your project workspace.)

6.  **Install the New `context-portal-mcp` Package:**
    ```bash
    uv install context-portal-mcp
    # Alternatively, using pip:
    # pip install context-portal-mcp
    ```

7.  **Restart the ConPort Server:**
    Start the ConPort server again. Since `context.db` no longer exists, Alembic will automatically create a new database with the latest schema defined by the installed `context-portal-mcp` version.

8.  **Import Data Back:**
    Use the `import_markdown_to_conport` tool to re-ingest your saved data into the newly created database.

    ```xml
    <use_mcp_tool>
    <server_name>conport</server_name>
    <tool_name>import_markdown_to_conport</tool_name>
    <arguments>
    {
      "workspace_id": "YOUR_WORKSPACE_ABSOLUTE_PATH",
      "input_path": "conport_backup"
    }
    </arguments>
    </use_mcp_tool>
    ```
    (Ensure `input_path` matches the `output_path` you used during export.)
